# This is a basic workflow to help you get started with Actions

name: CI

# Controls when the action will run. Triggers the workflow on push or pull request
# events but only for the master branch
on:
    push:
        branches: [ main ]

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
    # This workflow contains a single job called "build"
    build:
        # The type of runner that the job will run on
        runs-on: ubuntu-latest

        # Steps represent a sequence of tasks that will be executed as part of the job
        steps:
            # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
            -   uses: actions/checkout@v4
            -   uses: actions/setup-java@v4
                with:
                    java-version: '21'
                    distribution: 'temurin'

            # Runs a set of commands using the runners shell
            -   name: Build
                run: mvn -B package

            # Adds target server fingerprint to known hosts to prevent SCP failure
            -   name: Setup SCP
                run: |
                    mkdir -p ~/.ssh/ && touch ~/.ssh/known_hosts
                    ${{ secrets.AKAENE_SERVER_FINGERPRINT }} >> ~/.ssh/known_hosts

            -   name: Set up Apache Maven Repository
                uses: actions/setup-java@v4
                with: # running setup-java again overwrites the settings.xml
                    distribution: 'temurin'
                    java-version: '21'
                    server-id: akaene # Value of the distributionManagement/repository/id field of the pom.xml
                    server-username: MAVEN_USERNAME # env variable for username in deploy
                    server-password: MAVEN_PASSWORD # env variable for password in deploy

            -   name: Publish to Apache Maven Central
                run: mvn deploy
                env:
                    MAVEN_USERNAME: maven
                    MAVEN_PASSWORD: ${{ secrets.AKAENE_MAVEN_PASSWORD }}
